import { format } from "date-fns";

// Save general data to the user's browser's local storage
function saveData(key, value) {
  localStorage.setItem(key, value);
}

// Get general data from the user's browser's local storage
function getData(key) {
  return localStorage.getItem(key);
}

// Save task data to the user's browser's local storage
function saveTaskItem(primaryTaskBoardHeading, taskItemKey, taskItemObj) {
  let localStorageKey = determineLocalStorageKey(primaryTaskBoardHeading),
    taskDataObj = JSON.parse(getData(localStorageKey)),
    updatedTaskDataObj;

  switch (localStorageKey) {
    case "taskData":
      updatedTaskDataObj = updateTaskData(
        taskDataObj,
        taskItemKey,
        taskItemObj
      );
      break;
    case "completed":
      updatedTaskDataObj = updateCompleted(
        taskDataObj,
        taskItemKey,
        taskItemObj
      );
      break;
    case "projects":
      updatedTaskDataObj = updateProjects(
        taskDataObj,
        primaryTaskBoardHeading,
        taskItemKey,
        taskItemObj
      );
      break;
    default:
      console.log(`localStorage key: ${localStorageKey} does not exist.`);
      return;
  }

  saveData(localStorageKey, JSON.stringify(updatedTaskDataObj));
}

function updateTaskData(taskDataObj, taskItemKey, taskItemObj) {
  let priorityKey = getTaskPriorityKey(taskItemObj.priorityValue);

  // add the new task item to the taskData object
  taskDataObj[priorityKey][`${taskItemKey}`] = taskItemObj;

  return taskDataObj;
}

function updateCompleted(taskDataObj, taskItemKey, taskItemObj) {
  let todaysDate = format(new Date(), "PP");

  // If this is the first task completed for a given day, create the key based on the
  // date completed prior to moving the task data over to the completed key
  if (!taskDataObj.hasOwnProperty(todaysDate)) {
    taskDataObj[todaysDate] = {};
  }

  taskDataObj[todaysDate][`${taskItemKey}`] = taskItemObj;

  return taskDataObj;
}

function updateProjects(taskDataObj, projectName, taskItemKey, taskItemObj) {
  // if (taskDataObj.hasOwnProperty(projectName) && !taskItemKey) {
  //   console.log("There is a project with this name already!");
  //   return;
  // }

  // If taskItemKey is falsey, taskItemObj is as well. This only occurs when
  // a new project is created.
  if (!taskItemKey) {
    taskDataObj[projectName] = {};
  } else {
    taskDataObj[projectName][taskItemKey] = taskItemObj;
  }

  return taskDataObj;
}

// Get task data from the user's browser's local storage
function getTaskItem(primaryTaskBoardHeading, taskItemKey) {
  let taskItem,
    localStorageKey = determineLocalStorageKey(primaryTaskBoardHeading),
    taskDataObj = JSON.parse(getData(localStorageKey)),
    localStoragePrimaryKeys = Object.keys(taskDataObj);

  for (let i = 0; i < localStoragePrimaryKeys.length; i++) {
    let localStorageSecondaryKeys = localStoragePrimaryKeys[i];

    if (
      taskDataObj[localStorageSecondaryKeys].hasOwnProperty(`${taskItemKey}`)
    ) {
      taskItem = taskDataObj[localStorageSecondaryKeys][`${taskItemKey}`];
      break;
    }
  }

  return taskItem;
}

// Gets a copy of all task data, deletes a task, and rewrites
// the mutated task data back to localStorage. localStorage.removeItem()
// was not used since it only removes the first level of keys available to it.
function deleteTaskItem(primaryTaskBoardHeading, taskItemKey) {
  let localStorageKey = determineLocalStorageKey(primaryTaskBoardHeading),
    taskDataObj = JSON.parse(getData(localStorageKey)),
    taskDataObjKeys = Object.keys(taskDataObj);

  for (let i = 0; i < taskDataObjKeys.length; i++) {
    if (taskDataObj[taskDataObjKeys[i]].hasOwnProperty(taskItemKey)) {
      delete taskDataObj[taskDataObjKeys[i]][taskItemKey];
      break;
    }
  }

  saveData(localStorageKey, JSON.stringify(taskDataObj));
}

function deleteEmptyCompletionDateKeys() {
  let completionTaskDataObj = JSON.parse(getData("completed"));

  Object.keys(completionTaskDataObj).forEach((dateKey) => {
    if (!Object.keys(completionTaskDataObj[dateKey]).length) {
      delete completionTaskDataObj[dateKey];
    }
  });

  saveData("completed", JSON.stringify(completionTaskDataObj));
}

function getTaskPriorityKey(priorityValue) {
  let priorityKey;

  switch (priorityValue.toLowerCase()) {
    case "high":
      priorityKey = "highPriorityTasks";
      break;
    case "medium":
      priorityKey = "mediumPriorityTasks";
      break;
    case "low":
      priorityKey = "lowPriorityTasks";
      break;
    case "none":
      priorityKey = "noPriorityTasks";
      break;
    default:
      console.log(`Priority Value: ${priorityValue} does not exist.`);
      return;
  }

  return priorityKey;
}

function determineLocalStorageKey(currentTaskBoardViewHeading) {
  let key;

  switch (currentTaskBoardViewHeading.toLowerCase()) {
    case "inbox":
    case "today":
    case "upcoming":
    case "general task": // when "uncompleting" a task
      key = "taskData";
      break;
    case "completed":
      key = "completed";
      break;
    default: // Project specific data
      key = "projects";
      break;
  }

  return key;
}

export {
  saveData,
  getData,
  saveTaskItem,
  getTaskItem,
  deleteTaskItem,
  deleteEmptyCompletionDateKeys,
  getTaskPriorityKey,
  determineLocalStorageKey,
};
